<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>沉浸式族語教學計畫產生器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        .modal-content {
            position: relative;
            margin: 5% auto;
            padding: 2rem;
            width: 90%;
            max-width: 48rem; /* 768px */
            background-color: #ffffff;
            border-radius: 0.75rem; /* 12px */
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            animation: slideIn 0.3s ease;
        }
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
            color: #9CA3AF; /* gray-400 */
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .modal-close:hover {
            color: #374151; /* gray-700 */
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Loading Spinner */
        .loader {
            border: 5px solid #f3f3f3; /* Light grey */
            border-top: 5px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-6 md:p-12">

    <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-lg">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-700">沉浸式族語教學計畫產生器</h1>
            <p class="text-lg text-gray-600 mt-2">為您的族語教學提供即時的活動靈感與教案範本</p>
        </header>

        <!-- 主題輸入 -->
        <div class="mb-6">
            <label for="theme-input" class="block text-lg font-semibold text-gray-700 mb-3">1. 輸入或選擇本週主題：</label>
            <div class-="flex flex-wrap gap-2 mb-3">
                <button class="theme-btn bg-indigo-100 text-indigo-700 px-4 py-1.5 rounded-full hover:bg-indigo-200 transition">部落的食物</button>
                <button class="theme-btn bg-green-100 text-green-700 px-4 py-1.5 rounded-full hover:bg-green-200 transition">我們的家人</button>
                <button class="theme-btn bg-amber-100 text-amber-700 px-4 py-1.5 rounded-full hover:bg-amber-200 transition">傳統服飾</button>
                <button class="theme-btn bg-sky-100 text-sky-700 px-4 py-1.5 rounded-full hover:bg-sky-200 transition">天氣與自然</button>
                <button class="theme-btn bg-rose-100 text-rose-700 px-4 py-1.5 rounded-full hover:bg-rose-200 transition">我的身體</button>
                <button class="theme-btn bg-purple-100 text-purple-700 px-4 py-1.5 rounded-full hover:bg-purple-200 transition">部落節慶</button>
            </div>
            <input type="text" id="theme-input" class="w-full p-3 border border-gray-300 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="例如：山上的動物、傳統樂器...">
        </div>

        <!-- 產生按鈕 -->
        <div class="mb-8">
            <button id="generate-btn" class="w-full bg-indigo-600 text-white font-bold text-lg py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-transform duration-200 transform hover:scale-101 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                2. 產生隨機教學計畫 (8個活動)
            </button>
        </div>

        <!-- 活動卡片容器 -->
        <div id="activity-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
            <!-- 初始提示 -->
            <div id="initial-prompt" class="col-span-1 md:col-span-2 lg:col-span-4 text-center text-gray-500 p-8 bg-gray-50 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
                <h3 class="mt-2 text-lg font-medium">尚未產生計畫</h3>
                <p class="mt-1 text-sm">請在上方輸入您的教學主題，然後點擊按鈕。</p>
            </div>
        </div>
    </div>

    <!-- 教案彈出視窗 (Modal) -->
    <div id="lesson-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="modal-close-btn">&times;</span>
            <div id="modal-body" class="max-h-[80vh] overflow-y-auto pr-4">
                <!-- 內容將由 JS 動態填入 -->
            </div>
        </div>
    </div>

    <script type="module">
        // --- 完整活動資料庫 (包含課綱學習指標) ---
        const activityDatabase = [
            {
                title: "族語繪本共讀",
                icon: "📚",
                color: "bg-blue-100",
                description: "透過繪本故事，學習與 [主題] 相關的族語詞彙與句子。",
                lessonPlan: {
                    learningIndicators: [
                        "【語-大-1-5-2】理解故事的角色、情節與主題",
                        "【語-大-2-4-1】看圖片或圖畫書敘說有主題的故事",
                        "【情-大-1-2-2】辨識各種文本中主角的情緒"
                    ],
                    activityPrep: "準備 [主題] 相關族語繪本、字卡、提問單。",
                    activityFlow: `
                        <p class="mb-2"><strong>1. 引起動機 (繪本預測)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>教師出示繪本封面，引導幼兒觀察並猜測：「你看到了什麼？ (matsa kisu? / 族語)」、「故事可能在說什麼？」</li>
                        </ul>
                        <p class="mb-2"><strong>2. 發展活動 (共讀與討論)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>教師以族語為主，緩慢逐頁講述故事。</li>
                            <li>過程中針對 [主題] 相關的關鍵詞彙（例如：vutu/山豬、tjakus/地瓜）加重語氣並出示字卡。</li>
                            <li>提問引導幼兒連結生活經驗：「你有看過 [關鍵詞彙] 嗎？在哪裡看過？」</li>
                        </ul>
                        <p class="mb-2"><strong>3. 綜合活動 (繪本複述)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>邀請幼兒看著圖片，嘗試用族語說出故事中的句子或關鍵詞彙。</li>
                        </ul>
                    `,
                    keyVocabulary: "（請填入 [主題] 相關族語詞彙，例如：vutu/山豬、tjakus/地瓜、matsa?/什麼?）",
                    assessment: "能專注聆聽故事，並嘗試說出至少2個 [主題] 相關的族語詞彙。"
                }
            },
            {
                title: "部落美食動手做",
                icon: "🍲",
                color: "bg-amber-100",
                description: "實際製作 [主題] 相關的傳統食物，並學習食材的族語。",
                lessonPlan: {
                    learningIndicators: [
                        "【身-大-2-2-2】熟練手眼協調的精細動作 (如切、搓、揉)",
                        "【認-大-1-3-1】觀察生活物件的特徵",
                        "【社-大-2-2-3】考量自己與他人的能力和興趣，和他人分工合作"
                    ],
                    activityPrep: "準備 [主題] 食材（如：cinavu/吉拿富的葉子、米）、族語字卡、烹飪用具。",
                    activityFlow: `
                        <p class="mb-2"><strong>1. 引起動機 (食材觀察)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>教師展示製作 [cinavu/吉拿富] 所需的食材，引導幼兒觀察、觸摸、嗅聞。</li>
                            <li>提問：「這是什麼？(inasi? / 族語)」、「它摸起來/聞起來怎麼樣？」</li>
                        </ul>
                        <p class="mb-2"><strong>2. 發展活動 (分工製作)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>教師示範製作 [cinavu/吉拿富] 的步驟，並搭配族語解說。</li>
                            <li>幼兒分組進行，練習包裹、綑綁等精細動作。</li>
                            <li>教師巡視並提醒：「小心拿 (an-an / 族語)」、「慢慢來 (na-na / 族語)」</li>
                        </ul>
                        <p class="mb-2"><strong>3. 綜合活動 (品嚐與分享)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>食物蒸熟後，請幼兒品嚐。</li>
                            <li>分享：「好吃嗎？ (nalemedj? / 族語)」、「你最喜歡哪個部分？」</li>
                        </ul>
                    `,
                    keyVocabulary: "（請填入食材族語，例如：cinavu/吉拿富、vasa/芋頭、lavai/小米）",
                    assessment: "能參與製作過程，並在教師引導下說出「好吃 (nalemedj)」或食材名稱。"
                }
            },
            {
                title: "族語歌謠唱跳",
                icon: "🎶",
                color: "bg-pink-100",
                description: "學習一首與 [主題] 相關的族語歌謠，並配合肢體動作。",
                lessonPlan: {
                    learningIndicators: [
                        "【語-大-1-2-1】辨認兒歌與童詩的韻腳",
                        "【身-大-3-1-1】與他人合作展現各種創意姿勢與動作的組合",
                        "【美-大-2-2-3】運用哼唱、打擊樂器或身體動作進行創作"
                    ],
                    activityPrep: "準備 [主題] 族語歌謠音樂、歌詞大字報（圖文並茂）、樂器（如沙鈴）。",
                    activityFlow: `
                        <p class="mb-2"><strong>1. 引起動機 (音樂感受)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>播放族語歌謠，邀請幼兒先隨意擺動身體，感受音樂的節奏。</li>
                        </ul>
                        <p class="mb-2"><strong>2. 發展活動 (歌詞與動作)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>教師出示歌詞大字報，利用圖片輔助，逐句念唱歌詞。</li>
                            <li>引導幼兒將 [主題] 相關詞彙（例如：qadav/太陽）與動作連結（例如：雙手高舉）。</li>
                            <li>全體一起放慢速度，邊唱邊做動作。</li>
                        </ul>
                        <p class="mb-2"><strong>3. 綜合活動 (小小表演家)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>幼兒分組，可拿樂器或自創動作，上台表演一次。</li>
                            <li>大家一起說：「唱得很好！ (mapida! / 族語)」</li>
                        </ul>
                    `,
                    keyVocabulary: "（請填入歌謠中 [主題] 關鍵詞，例如：qadav/太陽、vulan/月亮、bintuhan/星星）",
                    assessment: "能跟著音樂哼唱，並做出至少2個對應的肢體動作。"
                }
            },
            {
                title: "大自然尋寶",
                icon: "🌲",
                color: "bg-green-100",
                description: "到戶外尋找 [主題] 相關的自然素材，並學習其族語名稱。",
                lessonPlan: {
                    learningIndicators: [
                        "【認-大-1-2-1】觀察動植物的生長變化",
                        "【身-大-2-1-2】在團體活動中，應用身體基本動作安全地完成任務",
                        "【語-大-2-3-1】敘說包含三個關聯事件的生活經驗"
                    ],
                    activityPrep: "尋寶籃、放大鏡、[主題] 相關的自然物圖卡（例如：qacu/葉子、vatu/石頭）。",
                    activityFlow: `
                        <p class="mb-2"><strong>1. 引起動機 (任務宣布)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>教師：「我們今天要去尋寶！ (masialu! / 族語)」，出示圖卡，請幼兒找出「長得一樣」的東西。</li>
                            <li>提醒戶外活動安全：「要小心 (an-an / 族語)」、「不要跑 (aiy-a masi-vavua / 族語)」。</li>
                        </ul>
                        <p class="mb-2"><strong>2. 發展活動 (戶外尋寶)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>幼兒在校園中自由探索，撿拾 [主題] 相關的自然物。</li>
                            <li>教師引導幼兒觀察：「你看！(k-m-atsa!) 這是 [qacu/葉子]。」</li>
                            <li>鼓勵幼兒使用放大鏡觀察細節。</li>
                        </ul>
                        <p class="mb-2"><strong>3. 綜合活動 (尋寶成果分享)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>回到教室，幼兒將撿到的寶物放到中間。</li>
                            <li>請幼兒分享：「你找到了什麼？(matsa kisu? / 族語)」、「我找到 [vatu/石頭]。」</li>
                        </ul>
                    `,
                    keyVocabulary: "（請填入自然素材族語，例如：qacu/葉子、vatu/石頭、vua/花）",
                    assessment: "能撿拾至少一種自然物，並在引導下嘗試說出其族語名稱。"
                }
            },
            {
                title: "傳統服飾創意畫",
                icon: "🎨",
                color: "bg-red-100",
                description: "觀察 [主題] 傳統服飾的圖紋，並進行創意繪畫。",
                lessonPlan: {
                    learningIndicators: [
                        "【美-大-1-2-1】探索生活環境中事物的色彩、形體、質地的美，感受其中的差異",
                        "【美-大-2-2-2】運用各種視覺藝術素材與工具的特性，進行創作",
                        "【認-大-1-3-1】觀察生活物件的特徵"
                    ],
                    activityPrep: "傳統服飾圖片/實物、圖畫紙、蠟筆、彩色筆、亮片等多元媒材。",
                    activityFlow: `
                        <p class="mb-2"><strong>1. 引起動機 (服飾欣賞)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>教師展示 [主題] 服飾（如：排灣族琉璃珠、百步蛇圖紋），引導幼兒觀察。</li>
                            <li>提問：「你看到什麼顏色？(tima nu caucau? / 族語)」、「有什麼圖案？」</li>
                        </ul>
                        <p class="mb-2"><strong>2. 發展活動 (創意設計)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>發給幼兒人形圖畫紙，邀請幼兒設計自己的 [主題] 衣服。</li>
                            <li>鼓勵幼兒使用多元媒材，畫出或貼出自己喜歡的圖紋。</li>
                        </ul>
                        <p class="mb-2"><strong>3. 綜合活動 (小小設計師)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>請幼兒上台展示自己的作品。</li>
                            <li>分享：「我畫的是 [百步蛇/vucul]。」、「我的衣服很漂亮 (mapidanga / 族語)！」</li>
                        </ul>
                    `,
                    keyVocabulary: "（請填入服飾或圖紋族語，例如：vucul/百步蛇、qata/琉璃珠、mapidanga/漂亮）",
                    assessment: "能運用至少兩種媒材進行創作，並能指出自己作品中的一個元素。"
                }
            },
            {
                title: "部落情境扮演",
                icon: "🎭",
                color: "bg-purple-100",
                description: "模擬 [主題] 的情境，例如：家人間的對話，練習生活族語。",
                lessonPlan: {
                    learningIndicators: [
                        "【社-大-1-5-1】探索社區中的人事物、活動、場所及其與自己的關係",
                        "【語-大-2-7-1】在扮演情境中依據角色的特質說話與互動",
                        "【情-大-2-1-3】以符合社會文化的方式來表達自己的情緒"
                    ],
                    activityPrep: "扮演區道具（如：[主題] 相關道具、族語電話）、角色頭飾（如：ina/媽媽、ama/爸爸）。",
                    activityFlow: `
                        <p class="mb-2"><strong>1. 引起動機 (情境設定)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>教師設定情境：「現在是早上，[ama/爸爸] 要去工作了，我們要跟他說什麼？」</li>
                        </ul>
                        <p class="mb-2"><strong>2. 發展活動 (角色扮演)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>幼兒自由選擇角色，進入扮演區。</li>
                            <li>教師以族語引導對話，例如：「[ina/媽媽]，午餐吃什麼？ (inasi ta ljemai? / 族語)」</li>
                            <li>鼓勵幼兒使用所學的族語（如：nanguaq/你好、masalu/謝謝）。</li>
                        </ul>
                        <p class="mb-2"><strong>3. 綜合活動 (分享與回饋)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>請幼兒分享：「你剛剛扮演誰？」「你說了什麼族語？」</li>
                        </ul>
                    `,
                    keyVocabulary: "（請填入 [主題] 相關稱謂或情境用語，例如：ina/媽媽、ama/爸爸、nanguaq/你好）",
                    assessment: "能在扮演情境中，主動說出至少一句族語（包含問候語）。"
                }
            },
            {
                title: "老幼共學日",
                icon: "👵👨‍",
                color: "bg-teal-100",
                description: "邀請部落耆老(Vuvu)來分享 [主題] 故事或技能。",
                lessonPlan: {
                    learningIndicators: [
                        "【社-大-3-3-3】尊重與自己不同性別、年齡、身心狀態的人",
                        "【語-大-1-1-1】合宜詮釋互動對象的表情和肢體動作",
                        "【認-大-1-3-1】觀察生活物件的特徵（此處指耆老的技能或文物）"
                    ],
                    activityPrep: "邀請函、接待禮儀演練、要請 Vuvu 分享的 [主題] 道具、給 Vuvu 的小禮物。",
                    activityFlow: `
                        <p class="mb-2"><strong>1. 引起動機 (Vuvu 來了)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>教師帶領幼兒練習族語問候語：「Vuvu, nanguaq! (Vuvu 您好！)」</li>
                            <li>提醒幼兒接待 Vuvu 的禮貌。</li>
                        </ul>
                        <p class="mb-2"><strong>2. 發展活動 (Vuvu 說故事)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>Vuvu 以族語分享 [主題] 相關的故事或傳統技能（例如：編織）。</li>
                            <li>教師在旁協助翻譯，並引導幼兒觀察 [主題] 道具。</li>
                        </ul>
                        <p class="mb-2"><strong>3. 綜合活動 (感謝 Vuvu)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>幼兒送上小禮物（例如：自己畫的卡片）。</li>
                            <li>全體一起說：「Vuvu, masalu! (Vuvu 謝謝您！)」</li>
                        </ul>
                    `,
                    keyVocabulary: "（Vuvu/耆老、nanguaq/你好、masalu/謝謝）",
                    assessment: "能安靜聆聽 Vuvu 分享，並能主動說出「Vuvu, nanguaq」或「Vuvu, masalu」。"
                }
            },
            {
                title: "親子學習單",
                icon: "🏠",
                color: "bg-cyan-100",
                description: "設計 [主題] 學習單，邀請家長回家與幼兒共學族語。",
                lessonPlan: {
                    learningIndicators: [
                        "【社-大-1-4-1】覺察自己及與家人間的相互照顧關係",
                        "【語-大-2-3-1】敘說包含三個關聯事件的生活經驗（分享在家學習的狀況）",
                        "【認-大-1-1-3】辨識生活環境中數字符號的意義（若學習單包含數字）"
                    ],
                    activityPrep: "設計 [主題] 相關的親子學習單（例如：圈圈看、連連看）、族語貼紙。",
                    activityFlow: `
                        <p class="mb-2"><strong>1. 引起動機 (任務說明)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>教師發下學習單，說明這是「回家和 ina/ama 一起玩的遊戲」。</li>
                            <li>說明 [主題] 學習單的內容，例如：「我們要找出 [vutu/山豬] 在哪裡。」</li>
                        </ul>
                        <p class="mb-2"><strong>2. 發展活動 (回家共學)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>（此階段在家中進行）家長陪同幼兒完成學習單，並一起念讀 [主題] 族語詞彙。</li>
                        </ul>
                        <p class="mb-2"><strong>3. 綜合活動 (成果分享)：</strong></p>
                        <ul class="list-disc list-inside ml-4 mb-3">
                            <li>隔天，請幼兒帶回學習單。</li>
                            <li>教師：「你回家有和 ina/ama 說族語嗎？」、「你學會了哪個族語？」</li>
                            <li>完成的幼兒可獲得族語貼紙。</li>
                        </ul>
                    `,
                    keyVocabulary: "（[主題] 相關詞彙、ina/媽媽、ama/爸爸）",
                    assessment: "能帶回學習單，並在引導下分享在家學習的一個詞彙或經驗。"
                }
            }
        ];

        // --- DOM 元素 ---
        const themeInput = document.getElementById('theme-input');
        const generateBtn = document.getElementById('generate-btn');
        const activityGrid = document.getElementById('activity-grid');
        const initialPrompt = document.getElementById('initial-prompt');
        const lessonModal = document.getElementById('lesson-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalBody = document.getElementById('modal-body');
        const themeButtons = document.querySelectorAll('.theme-btn');

        // --- 事件監聽 ---
        
        // 主題按鈕
        themeButtons.forEach(button => {
            button.addEventListener('click', () => {
                themeInput.value = button.textContent;
            });
        });

        // 產生計畫按鈕
        generateBtn.addEventListener('click', generatePlan);

        // 關閉 Modal
        modalCloseBtn.addEventListener('click', () => {
            lessonModal.style.display = 'none';
        });

        // 點擊 Modal 外部關閉
        window.addEventListener('click', (event) => {
            if (event.target == lessonModal) {
                lessonModal.style.display = 'none';
            }
        });

        // --- 核心功能 ---

        // 1. 產生計畫
        function generatePlan() {
            const theme = themeInput.value.trim() || "（未填主題）";
            
            // 隱藏初始提示
            if (initialPrompt) {
                initialPrompt.style.display = 'none';
            }

            // 清空舊卡片
            activityGrid.innerHTML = '';

            // 隨機選擇8個活動
            const selectedActivities = shuffleArray(activityDatabase).slice(0, 8);

            // 產生新的活動卡片
            selectedActivities.forEach(activity => {
                const card = document.createElement('div');
                card.className = `card p-4 rounded-lg shadow-sm cursor-pointer ${activity.color} bg-opacity-70`;
                
                // 動態替換 [主題]
                const description = activity.description.replace(/\[主題\]/g, `<span class="font-bold text-indigo-700">${theme}</span>`);

                card.innerHTML = `
                    <div class="text-4xl mb-2">${activity.icon}</div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-1">${activity.title}</h3>
                    <p class="text-sm text-gray-700">${description}</p>
                `;
                
                // 點擊卡片顯示教案
                card.addEventListener('click', () => showModal(activity, theme));
                activityGrid.appendChild(card);
            });
        }

        // 2. 隨機排序陣列 (Fisher-Yates Shuffle)
        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // 3. 顯示教案 Modal
        function showModal(activity, theme) {
            const plan = activity.lessonPlan;
            if (!plan) {
                console.error("找不到教案內容");
                return;
            }

            // 動態替換 [主題]
            const indicatorsList = (plan.learningIndicators || []).map(item => `<li class="mb-1">${item.replace(/\[主題\]/g, theme)}</li>`).join('');
            const activityPrep = (plan.activityPrep || "").replace(/\[主題\]/g, theme);
            const activityFlow = (plan.activityFlow || "").replace(/\[主題\]/g, theme);
            const keyVocabulary = (plan.keyVocabulary || "").replace(/\[主題\]/g, theme);
            const assessment = (plan.assessment || "").replace(/\[主題\]/g, theme);

            // 建立 AI 圖片提示詞 (中文)
            const aiPrompt = `簡單的著色圖風格，${theme}，${activity.title}`;

            modalBody.innerHTML = `
                <h2 class="text-2xl font-bold text-indigo-700 mb-4">${activity.icon} ${activity.title}</h2>
                <div class="space-y-5">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 border-b-2 border-indigo-200 pb-1 mb-2">學習指標 (依據課綱)</h3>
                        <ul class="list-disc list-inside text-gray-700">${indicatorsList}</ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 border-b-2 border-indigo-200 pb-1 mb-2">活動準備</h3>
                        <p class="text-gray-700">${activityPrep}</p>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 border-b-2 border-indigo-200 pb-1 mb-2">活動流程</h3>
                        <div class="text-gray-700">${activityFlow}</div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 border-b-2 border-indigo-200 pb-1 mb-2">應用族語 (範例)</h3>
                        <p class="text-gray-700">${keyVocabulary}</p>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 border-b-2 border-indigo-200 pb-1 mb-2">評量方式 (範例)</h3>
                        <p class="text-gray-700">${assessment}</p>
                    </div>

                    <!-- 教學省思 (AI 產生) -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 border-b-2 border-indigo-200 pb-1 mb-2">教學省思 (AI 產生)</h3>
                        <button id="ai-reflection-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition mb-2">
                            產生教學省思
                        </button>
                        <div id="ai-reflection-output" class="mt-2 p-3 bg-gray-50 rounded-lg min-h-[100px] text-gray-700 whitespace-pre-wrap">
                            <!-- 省思內容會顯示在這裡 -->
                        </div>
                    </div>

                    <!-- AI 圖片產生器 -->
                    <div class="pt-4 border-t border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">教具圖片產生 (AI)</h3>
                        <p class="text-sm text-gray-600 mb-2">請輸入 <strong>中文</strong> 提示詞來產生教學圖片（例如：著色圖、動物圖卡）。</p>
                        <input type="text" id="ai-prompt-input" class="w-full p-2 border border-gray-300 rounded-lg mb-2" value="${aiPrompt}">
                        <button id="ai-generate-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition">
                            產生圖片 (3張)
                        </button>
                        <div id="ai-image-output" class="mt-4 grid grid-cols-3 gap-2 min-h-[50px]">
                            <!-- 圖片或 Loading 會顯示在這裡 -->
                        </div>
                    </div>
                </div>
            `;
            
            lessonModal.style.display = 'block';

            // 必須在 modalBody.innerHTML 之後才能抓到按鈕
            document.getElementById('ai-generate-btn').addEventListener('click', handleImageGeneration);
            // 替省思按鈕加上事件監聽
            document.getElementById('ai-reflection-btn').addEventListener('click', () => handleReflectionGeneration(activity, theme, plan));
        }

        // --- AI 文字產生相關函式 (教學省思) ---

        // 4. 處理省思產生點擊
        async function handleReflectionGeneration(activity, theme, plan) {
            const outputDiv = document.getElementById('ai-reflection-output');
            outputDiv.innerHTML = '<div class="loader mx-auto"></div>'; // 顯示 Loading

            const systemPrompt = "你是一位經驗豐富的幼兒園沉浸式族語教保員。請根據以下提供的教案內容，撰寫一段 150-200 字的「教學省思」。省思內容應包含：(1) 對此活動預期幼兒學習成效的評估。(2) 教保員在引導過程中應注意的重點（例如：如何引導族語使用、如何處理幼兒的反應）。(3) 活動可以如何延伸或改進。請使用繁體中文。";
            
            // 清理活動流程中的 HTML 標籤
            const cleanActivityFlow = plan.activityFlow.replace(/<[^>]*>/g, "\n").replace(/\n+/g, "\n").trim();

            const userQuery = `
        教案主題：${theme}
        活動名稱：${activity.title}
        學習指標：
        ${(plan.learningIndicators || []).join('\n')}
        活動流程：
        ${cleanActivityFlow}
        評量方式：${plan.assessment}

        請開始撰寫教學省思：
            `;

            try {
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                const result = await fetchTextApiWithBackoff(payload);
                
                if (result.candidates && result.candidates[0].content?.parts?.[0]?.text) {
                    const reflectionText = result.candidates[0].content.parts[0].text;
                    outputDiv.innerHTML = reflectionText;
                } else {
                    throw new Error('AI 未能返回有效的省思內容。');
                }

            } catch (error) {
                console.error('AI 省思產生失敗:', error);
                outputDiv.innerHTML = `<p class="text-red-500">省思產生失敗：${error.message}</p>`;
            }
        }

        // 5. 呼叫文字 API (gemini-2.5-flash-preview-09-2025)
        async function fetchTextApiWithBackoff(payload, retries = 3, delay = 1000) {
            const apiKey = ""; // API Key 會在執行環境中自動提供
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API 錯誤： ${response.status} ${response.statusText}. Body: ${errorBody}`);
                    }

                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(`API 返回錯誤： ${result.error.message}`);
                    }
                    if (!result.candidates || result.candidates.length === 0) {
                        if (result.promptFeedback && result.promptFeedback.blockReason) {
                            throw new Error(`請求被阻擋： ${result.promptFeedback.blockReason}`);
                        }
                        throw new Error('API 未返回任何候選內容。');
                    }
                    
                    return result; // 成功
                
                } catch (error) {
                    // 不在控制台顯示重試的日誌，除非是最後一次失敗
                    if (i === retries - 1) {
                        console.error(`AI text call failed after ${retries} attempts: ${error.message}`);
                        throw error; // 最後一次嘗試失敗，拋出錯誤
                    }
                    await new Promise(resolve => setTimeout(resolve, delay * (i + 1))); // 指數退避
                }
            }
        }

        // --- AI 圖片產生相關函式 ---

        // 6. 處理圖片產生點擊
        async function handleImageGeneration() {
            const promptInput = document.getElementById('ai-prompt-input');
            const outputDiv = document.getElementById('ai-image-output');
            const prompt = promptInput.value;

            if (!prompt) {
                outputDiv.innerHTML = '<p class="text-red-500 col-span-3">請輸入提示詞！</p>';
                return;
            }

            outputDiv.innerHTML = '<div class="loader col-span-3"></div>'; // 顯示 Loading

            try {
                // 呼叫 API，請求 3 張圖片
                const result = await fetchImageApiWithBackoff({
                    instances: { prompt: prompt },
                    parameters: { "sampleCount": 3 }
                });
                
                if (result.predictions && result.predictions.length > 0) {
                    outputDiv.innerHTML = ''; // 清除 Loading
                    result.predictions.forEach(prediction => {
                        if (prediction.bytesBase64Encoded) {
                            const img = document.createElement('img');
                            img.src = `data:image/png;base64,${prediction.bytesBase64Encoded}`;
                            img.className = "w-full h-auto object-cover rounded-lg shadow-md";
                            outputDiv.appendChild(img);
                        }
                    });
                } else {
                    throw new Error('AI 未能返回有效的圖片。');
                }
            } catch (error) {
                console.error('AI 圖片產生失敗:', error);
                outputDiv.innerHTML = `<p class="text-red-500 col-span-3">圖片產生失敗：${error.message}</p>`;
            }
        }

        // 7. 呼叫圖片 API (imagen-3.0-generate-002)
        async function fetchImageApiWithBackoff(payload, retries = 3, delay = 1000) {
            const apiKey = ""; // API Key 會在執行環境中自動提供
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API 錯誤： ${response.status} ${response.statusText}. Body: ${errorBody}`);
                    }

                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(`API 返回錯誤： ${result.error.message}`);
                    }
                    
                    return result; // 成功
                
                } catch (error) {
                     // 不在控制台顯示重試的日誌，除非是最後一次失敗
                    if (i === retries - 1) {
                        console.error(`AI image call failed after ${retries} attempts: ${error.message}`);
                        throw error; // 最後一次嘗試失敗，拋出錯誤
                    }
                    await new Promise(resolve => setTimeout(resolve, delay * (i + 1))); // 指數退避
                }
            }
        }

    </script>
</body>
</html>
